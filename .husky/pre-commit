#!/bin/sh
set -e

# Ensure Homebrew paths are available (macOS GUI apps often miss them)
if [ -x "/opt/homebrew/bin/brew" ]; then
	eval "$('/opt/homebrew/bin/brew' shellenv)"
elif [ -x "/usr/local/bin/brew" ]; then
	eval "$('/usr/local/bin/brew' shellenv)"
fi

# Run PHP CS Fixer on staged PHP files (process NUL-delimited list safely)
git diff --cached --name-only -z --diff-filter=ACMR -- '*.php' |
while IFS= read -r -d '' file; do
	# Fix the file
	php ./vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.dist.php --allow-risky=yes -- "$file"
	# Re-add potentially reformatted file to the index
	git add -- "$file"
done

exit 0
